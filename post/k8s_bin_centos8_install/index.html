<!DOCTYPE html>
<html lang="zh-cn">
<head>
	
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-154483127-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-154483127-1');
</script>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>kubernetes 1.17.0安装在centos8 安装体验 - Myki的博客</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Myki" /><meta name="description" content="centos8 centos8.1刚刚发布 闲来没事体验一波
" /><meta name="keywords" content="kubernetes, prometheus2, grafana, 升级" />






<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-2427629508597494",
    enable_page_level_ads: true
  });
</script>


<meta name="generator" content="Hugo 0.61.0 with theme even" />


<link rel="canonical" href="https://www.1nth.com/post/k8s_bin_centos8_install/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="kubernetes 1.17.0安装在centos8 安装体验" />
<meta property="og:description" content="centos8 centos8.1刚刚发布 闲来没事体验一波" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.1nth.com/post/k8s_bin_centos8_install/" />
<meta property="article:published_time" content="2020-01-20T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-01-20T09:00:23+08:00" />
<meta itemprop="name" content="kubernetes 1.17.0安装在centos8 安装体验">
<meta itemprop="description" content="centos8 centos8.1刚刚发布 闲来没事体验一波">
<meta itemprop="datePublished" content="2020-01-20T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2020-01-20T09:00:23&#43;08:00" />
<meta itemprop="wordCount" content="3853">



<meta itemprop="keywords" content="kubernetes,linux,centos," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="kubernetes 1.17.0安装在centos8 安装体验"/>
<meta name="twitter:description" content="centos8 centos8.1刚刚发布 闲来没事体验一波"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Even</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Even</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">kubernetes 1.17.0安装在centos8 安装体验</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-01-20 </span>
        <div class="post-category">
            <a href="/categories/centos/"> centos </a>
            </div>
        
      </div>
    </header>

    
    <div class="post-content">
      <p><code>centos8 </code>centos8.1刚刚发布 闲来没事体验一波</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span><span class="lnt">461
</span><span class="lnt">462
</span><span class="lnt">463
</span><span class="lnt">464
</span><span class="lnt">465
</span><span class="lnt">466
</span><span class="lnt">467
</span><span class="lnt">468
</span><span class="lnt">469
</span><span class="lnt">470
</span><span class="lnt">471
</span><span class="lnt">472
</span><span class="lnt">473
</span><span class="lnt">474
</span><span class="lnt">475
</span><span class="lnt">476
</span><span class="lnt">477
</span><span class="lnt">478
</span><span class="lnt">479
</span><span class="lnt">480
</span><span class="lnt">481
</span><span class="lnt">482
</span><span class="lnt">483
</span><span class="lnt">484
</span><span class="lnt">485
</span><span class="lnt">486
</span><span class="lnt">487
</span><span class="lnt">488
</span><span class="lnt">489
</span><span class="lnt">490
</span><span class="lnt">491
</span><span class="lnt">492
</span><span class="lnt">493
</span><span class="lnt">494
</span><span class="lnt">495
</span><span class="lnt">496
</span><span class="lnt">497
</span><span class="lnt">498
</span><span class="lnt">499
</span><span class="lnt">500
</span><span class="lnt">501
</span><span class="lnt">502
</span><span class="lnt">503
</span><span class="lnt">504
</span><span class="lnt">505
</span><span class="lnt">506
</span><span class="lnt">507
</span><span class="lnt">508
</span><span class="lnt">509
</span><span class="lnt">510
</span><span class="lnt">511
</span><span class="lnt">512
</span><span class="lnt">513
</span><span class="lnt">514
</span><span class="lnt">515
</span><span class="lnt">516
</span><span class="lnt">517
</span><span class="lnt">518
</span><span class="lnt">519
</span><span class="lnt">520
</span><span class="lnt">521
</span><span class="lnt">522
</span><span class="lnt">523
</span><span class="lnt">524
</span><span class="lnt">525
</span><span class="lnt">526
</span><span class="lnt">527
</span><span class="lnt">528
</span><span class="lnt">529
</span><span class="lnt">530
</span><span class="lnt">531
</span><span class="lnt">532
</span><span class="lnt">533
</span><span class="lnt">534
</span><span class="lnt">535
</span><span class="lnt">536
</span><span class="lnt">537
</span><span class="lnt">538
</span><span class="lnt">539
</span><span class="lnt">540
</span><span class="lnt">541
</span><span class="lnt">542
</span><span class="lnt">543
</span><span class="lnt">544
</span><span class="lnt">545
</span><span class="lnt">546
</span><span class="lnt">547
</span><span class="lnt">548
</span><span class="lnt">549
</span><span class="lnt">550
</span><span class="lnt">551
</span><span class="lnt">552
</span><span class="lnt">553
</span><span class="lnt">554
</span><span class="lnt">555
</span><span class="lnt">556
</span><span class="lnt">557
</span><span class="lnt">558
</span><span class="lnt">559
</span><span class="lnt">560
</span><span class="lnt">561
</span><span class="lnt">562
</span><span class="lnt">563
</span><span class="lnt">564
</span><span class="lnt">565
</span><span class="lnt">566
</span><span class="lnt">567
</span><span class="lnt">568
</span><span class="lnt">569
</span><span class="lnt">570
</span><span class="lnt">571
</span><span class="lnt">572
</span><span class="lnt">573
</span><span class="lnt">574
</span><span class="lnt">575
</span><span class="lnt">576
</span><span class="lnt">577
</span><span class="lnt">578
</span><span class="lnt">579
</span><span class="lnt">580
</span><span class="lnt">581
</span><span class="lnt">582
</span><span class="lnt">583
</span><span class="lnt">584
</span><span class="lnt">585
</span><span class="lnt">586
</span><span class="lnt">587
</span><span class="lnt">588
</span><span class="lnt">589
</span><span class="lnt">590
</span><span class="lnt">591
</span><span class="lnt">592
</span><span class="lnt">593
</span><span class="lnt">594
</span><span class="lnt">595
</span><span class="lnt">596
</span><span class="lnt">597
</span><span class="lnt">598
</span><span class="lnt">599
</span><span class="lnt">600
</span><span class="lnt">601
</span><span class="lnt">602
</span><span class="lnt">603
</span><span class="lnt">604
</span><span class="lnt">605
</span><span class="lnt">606
</span><span class="lnt">607
</span><span class="lnt">608
</span><span class="lnt">609
</span><span class="lnt">610
</span><span class="lnt">611
</span><span class="lnt">612
</span><span class="lnt">613
</span><span class="lnt">614
</span><span class="lnt">615
</span><span class="lnt">616
</span><span class="lnt">617
</span><span class="lnt">618
</span><span class="lnt">619
</span><span class="lnt">620
</span><span class="lnt">621
</span><span class="lnt">622
</span><span class="lnt">623
</span><span class="lnt">624
</span><span class="lnt">625
</span><span class="lnt">626
</span><span class="lnt">627
</span><span class="lnt">628
</span><span class="lnt">629
</span><span class="lnt">630
</span><span class="lnt">631
</span><span class="lnt">632
</span><span class="lnt">633
</span><span class="lnt">634
</span><span class="lnt">635
</span><span class="lnt">636
</span><span class="lnt">637
</span><span class="lnt">638
</span><span class="lnt">639
</span><span class="lnt">640
</span><span class="lnt">641
</span><span class="lnt">642
</span><span class="lnt">643
</span><span class="lnt">644
</span><span class="lnt">645
</span><span class="lnt">646
</span><span class="lnt">647
</span><span class="lnt">648
</span><span class="lnt">649
</span><span class="lnt">650
</span><span class="lnt">651
</span><span class="lnt">652
</span><span class="lnt">653
</span><span class="lnt">654
</span><span class="lnt">655
</span><span class="lnt">656
</span><span class="lnt">657
</span><span class="lnt">658
</span><span class="lnt">659
</span><span class="lnt">660
</span><span class="lnt">661
</span><span class="lnt">662
</span><span class="lnt">663
</span><span class="lnt">664
</span><span class="lnt">665
</span><span class="lnt">666
</span><span class="lnt">667
</span><span class="lnt">668
</span><span class="lnt">669
</span><span class="lnt">670
</span><span class="lnt">671
</span><span class="lnt">672
</span><span class="lnt">673
</span><span class="lnt">674
</span><span class="lnt">675
</span><span class="lnt">676
</span><span class="lnt">677
</span><span class="lnt">678
</span><span class="lnt">679
</span><span class="lnt">680
</span><span class="lnt">681
</span><span class="lnt">682
</span><span class="lnt">683
</span><span class="lnt">684
</span><span class="lnt">685
</span><span class="lnt">686
</span><span class="lnt">687
</span><span class="lnt">688
</span><span class="lnt">689
</span><span class="lnt">690
</span><span class="lnt">691
</span><span class="lnt">692
</span><span class="lnt">693
</span><span class="lnt">694
</span><span class="lnt">695
</span><span class="lnt">696
</span><span class="lnt">697
</span><span class="lnt">698
</span><span class="lnt">699
</span><span class="lnt">700
</span><span class="lnt">701
</span><span class="lnt">702
</span><span class="lnt">703
</span><span class="lnt">704
</span><span class="lnt">705
</span><span class="lnt">706
</span><span class="lnt">707
</span><span class="lnt">708
</span><span class="lnt">709
</span><span class="lnt">710
</span><span class="lnt">711
</span><span class="lnt">712
</span><span class="lnt">713
</span><span class="lnt">714
</span><span class="lnt">715
</span><span class="lnt">716
</span><span class="lnt">717
</span><span class="lnt">718
</span><span class="lnt">719
</span><span class="lnt">720
</span><span class="lnt">721
</span><span class="lnt">722
</span><span class="lnt">723
</span><span class="lnt">724
</span><span class="lnt">725
</span><span class="lnt">726
</span><span class="lnt">727
</span><span class="lnt">728
</span><span class="lnt">729
</span><span class="lnt">730
</span><span class="lnt">731
</span><span class="lnt">732
</span><span class="lnt">733
</span><span class="lnt">734
</span><span class="lnt">735
</span><span class="lnt">736
</span><span class="lnt">737
</span><span class="lnt">738
</span><span class="lnt">739
</span><span class="lnt">740
</span><span class="lnt">741
</span><span class="lnt">742
</span><span class="lnt">743
</span><span class="lnt">744
</span><span class="lnt">745
</span><span class="lnt">746
</span><span class="lnt">747
</span><span class="lnt">748
</span><span class="lnt">749
</span><span class="lnt">750
</span><span class="lnt">751
</span><span class="lnt">752
</span><span class="lnt">753
</span><span class="lnt">754
</span><span class="lnt">755
</span><span class="lnt">756
</span><span class="lnt">757
</span><span class="lnt">758
</span><span class="lnt">759
</span><span class="lnt">760
</span><span class="lnt">761
</span><span class="lnt">762
</span><span class="lnt">763
</span><span class="lnt">764
</span><span class="lnt">765
</span><span class="lnt">766
</span><span class="lnt">767
</span><span class="lnt">768
</span><span class="lnt">769
</span><span class="lnt">770
</span><span class="lnt">771
</span><span class="lnt">772
</span><span class="lnt">773
</span><span class="lnt">774
</span><span class="lnt">775
</span><span class="lnt">776
</span><span class="lnt">777
</span><span class="lnt">778
</span><span class="lnt">779
</span><span class="lnt">780
</span><span class="lnt">781
</span><span class="lnt">782
</span><span class="lnt">783
</span><span class="lnt">784
</span><span class="lnt">785
</span><span class="lnt">786
</span><span class="lnt">787
</span><span class="lnt">788
</span><span class="lnt">789
</span><span class="lnt">790
</span><span class="lnt">791
</span><span class="lnt">792
</span><span class="lnt">793
</span><span class="lnt">794
</span><span class="lnt">795
</span><span class="lnt">796
</span><span class="lnt">797
</span><span class="lnt">798
</span><span class="lnt">799
</span><span class="lnt">800
</span><span class="lnt">801
</span><span class="lnt">802
</span><span class="lnt">803
</span><span class="lnt">804
</span><span class="lnt">805
</span><span class="lnt">806
</span><span class="lnt">807
</span><span class="lnt">808
</span><span class="lnt">809
</span><span class="lnt">810
</span><span class="lnt">811
</span><span class="lnt">812
</span><span class="lnt">813
</span><span class="lnt">814
</span><span class="lnt">815
</span><span class="lnt">816
</span><span class="lnt">817
</span><span class="lnt">818
</span><span class="lnt">819
</span><span class="lnt">820
</span><span class="lnt">821
</span><span class="lnt">822
</span><span class="lnt">823
</span><span class="lnt">824
</span><span class="lnt">825
</span><span class="lnt">826
</span><span class="lnt">827
</span><span class="lnt">828
</span><span class="lnt">829
</span><span class="lnt">830
</span><span class="lnt">831
</span><span class="lnt">832
</span><span class="lnt">833
</span><span class="lnt">834
</span><span class="lnt">835
</span><span class="lnt">836
</span><span class="lnt">837
</span><span class="lnt">838
</span><span class="lnt">839
</span><span class="lnt">840
</span><span class="lnt">841
</span><span class="lnt">842
</span><span class="lnt">843
</span><span class="lnt">844
</span><span class="lnt">845
</span><span class="lnt">846
</span><span class="lnt">847
</span><span class="lnt">848
</span><span class="lnt">849
</span><span class="lnt">850
</span><span class="lnt">851
</span><span class="lnt">852
</span><span class="lnt">853
</span><span class="lnt">854
</span><span class="lnt">855
</span><span class="lnt">856
</span><span class="lnt">857
</span><span class="lnt">858
</span><span class="lnt">859
</span><span class="lnt">860
</span><span class="lnt">861
</span><span class="lnt">862
</span><span class="lnt">863
</span><span class="lnt">864
</span><span class="lnt">865
</span><span class="lnt">866
</span><span class="lnt">867
</span><span class="lnt">868
</span><span class="lnt">869
</span><span class="lnt">870
</span><span class="lnt">871
</span><span class="lnt">872
</span><span class="lnt">873
</span><span class="lnt">874
</span><span class="lnt">875
</span><span class="lnt">876
</span><span class="lnt">877
</span><span class="lnt">878
</span><span class="lnt">879
</span><span class="lnt">880
</span><span class="lnt">881
</span><span class="lnt">882
</span><span class="lnt">883
</span><span class="lnt">884
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1">#centos8  install</span> 
<span class="c1">#在启动项添加 网卡命名 禁用ipv6 https://www.aikaiyuan.com/12535.html</span>
net.ifnames<span class="o">=</span><span class="m">0</span> <span class="nv">biosdevname</span><span class="o">=</span><span class="m">0</span> ipv6.disable<span class="o">=</span>1
cat /etc/default/grub 
sed <span class="s1">&#39;s/quiet/net.ifnames=0 biosdevname=0 ipv6.disable=1 quiet/g&#39;</span> /etc/default/grub
grub2-mkconfig -o /boot/grub2/grub.cfg 
<span class="c1"># 内核地址 https://elrepo.org/linux/kernel/el7/x86_64/RPMS/</span>
<span class="c1">#  历史版本http://www.jules.fm/elrepo/archive/kernel/el7/x86_64/RPMS/</span>
<span class="c1">#   https://mirror.yandex.ru/fedora/elrepo/archive/kernel/el7/x86_64/RPMS/</span>


<span class="c1">#网络配置 https://www.linuxrumen.com/rmxx/973.html</span>
nmcli connection modify eth ipv4.addresses 192.168.1.11/24
nmcli connection modify eth0 ipv4.dns 223.5.5.5 ipv4.gateway 192.168.1.254
nmcli con modify eth0 connection.autoconnect yes  <span class="c1">#对应onboot=yes</span>
nmcli connection modify eth0 ipv4.method manual <span class="c1">#对应的是stati=manual  auto=dhcp</span>
cmcli c up eth0
nmcli device connect eth0
nmcli device reapply eth0
nmcli c reload
systemctl restart NetworkManager



<span class="c1">#系统优化</span>
setenforce 0
sed -i <span class="s1">&#39;/^SELINUX=/cSELINUX=disabled&#39;</span> /etc/selinux/config
systemctl disable --now firewalld 
swapoff -a
sed -i <span class="s1">&#39;/^#UseDNS yes/cUseDNS no&#39;</span> /etc/ssh/sshd_config
yes <span class="p">|</span> cp /etc/fstab /etc/fstab_bak
cat /etc/fstab_bak <span class="p">|</span>grep -v swap &gt; /etc/fstab


<span class="c1">#加载内核模块</span>
cat &gt; /etc/modules-load.d/10-k8s-modules.conf <span class="s">&lt;&lt;EOF
</span><span class="s">br_netfilter
</span><span class="s">ip_vs
</span><span class="s">ip_vs_rr
</span><span class="s">ip_vs_wrr
</span><span class="s">ip_vs_sh
</span><span class="s">nf_conntrack_ipv4
</span><span class="s">nf_conntrack
</span><span class="s">EOF</span>


cat <span class="s">&lt;&lt;EOF &gt; /etc/sysctl.d/95-k8s-sysctl.conf
</span><span class="s">net.ipv4.tcp_keepalive_time = 600
</span><span class="s">net.ipv4.tcp_keepalive_intvl = 30
</span><span class="s">net.ipv4.tcp_keepalive_probes = 10
</span><span class="s">net.ipv6.conf.all.disable_ipv6 = 1
</span><span class="s">net.ipv6.conf.default.disable_ipv6 = 1
</span><span class="s">net.ipv6.conf.lo.disable_ipv6 = 1
</span><span class="s">net.ipv4.neigh.default.gc_stale_time = 120
</span><span class="s">net.ipv4.conf.all.rp_filter = 0
</span><span class="s">net.ipv4.conf.default.rp_filter = 0
</span><span class="s">net.ipv4.conf.default.arp_announce = 2
</span><span class="s">net.ipv4.conf.lo.arp_announce = 2
</span><span class="s">net.ipv4.conf.all.arp_announce = 2
</span><span class="s">net.ipv4.ip_forward = 1
</span><span class="s">net.ipv4.tcp_max_tw_buckets = 5000
</span><span class="s">net.ipv4.tcp_syncookies = 1
</span><span class="s">net.ipv4.tcp_max_syn_backlog = 1024
</span><span class="s">net.ipv4.tcp_synack_retries = 2
</span><span class="s">net.bridge.bridge-nf-call-ip6tables = 1
</span><span class="s">net.bridge.bridge-nf-call-iptables = 1
</span><span class="s">net.netfilter.nf_conntrack_max = 2310720
</span><span class="s">fs.inotify.max_user_watches=89100
</span><span class="s">fs.may_detach_mounts = 1
</span><span class="s">fs.file-max = 52706963
</span><span class="s">fs.nr_open = 52706963
</span><span class="s">net.bridge.bridge-nf-call-arptables = 1
</span><span class="s">vm.swappiness = 0
</span><span class="s">vm.overcommit_memory=1
</span><span class="s">vm.panic_on_oom=0
</span><span class="s">EOF</span>

sysctl --system

<span class="c1">#预留内存,避免由于内存耗尽导致ssh连不上主机,比如100M，资源充足建议大点</span>
cat <span class="s">&lt;&lt;EOF &gt; /etc/sysctl.conf
</span><span class="s">vm.min_free_kbytes=100000
</span><span class="s">net.ipv4.tcp_keepalive_time = 50
</span><span class="s">net.ipv4.ip_local_port_range = 1024 65000
</span><span class="s">net.ipv4.tcp_max_syn_backlog = 8192
</span><span class="s">net.ipv4.tcp_max_tw_buckets = 3000
</span><span class="s">net.ipv4.tcp_syncookies = 1
</span><span class="s">net.ipv4.tcp_tw_reuse = 1
</span><span class="s">net.ipv4.tcp_tw_recycle = 1
</span><span class="s">net.ipv4.tcp_fin_timeout = 30
</span><span class="s">net.ipv4.ip_forward = 1
</span><span class="s">EOF</span>
sysctl -p

cat <span class="s">&lt;&lt;EOF &gt;&gt;/etc/security/limits.conf
</span><span class="s">* soft nofile 65536
</span><span class="s">* hard nofile 65536
</span><span class="s">* soft nproc 65536
</span><span class="s">* hard nproc 65536
</span><span class="s">* soft  memlock  unlimited
</span><span class="s">* hard memlock  unlimited
</span><span class="s">EOF</span>

dnf -y install chrony git vim wget nfs-utils socat bash-completion  conntrack-tools ipset ipvsadm libseccomp psmisc rsync
<span class="c1">#安装基础软件包</span>
- name: 安装基础软件包
  yum: 
    name: 
      - bash-completion     <span class="c1"># bash命令补全工具，需要重新登录服务器生效</span>
      - conntrack-tools     <span class="c1"># ipvs 模式需要</span>
      - ipset               <span class="c1"># ipvs 模式需要</span>
      - ipvsadm             <span class="c1"># ipvs 模式需要</span>
      - libseccomp          <span class="c1"># 安装containerd需要</span>
      - nfs-utils           <span class="c1"># 挂载nfs 共享文件需要 (创建基于 nfs的PV 需要)</span>
      - psmisc              <span class="c1"># 安装psmisc 才能使用命令killall，keepalive的监测脚本需要</span>
      - rsync               <span class="c1"># 文件同步工具，分发证书等配置文件需要</span>
      - socat               <span class="c1"># 用于port forwarding</span>
    state: present
  when: <span class="s1">&#39;INSTALL_SOURCE != &#34;offline&#34;&#39;</span>
<span class="c1">#同步下时间先</span>
systemctl is-enabled chronyd
timedatectl list-timezones <span class="c1"># 列出所有时区</span>
timedatectl set-local-rtc <span class="m">1</span> <span class="c1"># 将硬件时钟调整为与本地时钟一致, 0 为设置为 UTC 时间</span>
timedatectl set-timezone Asia/Shanghai <span class="c1"># 设置系统时区为上海</span>
timedatectl set-ntp yes <span class="c1"># 设置开启自动同步</span>

systemctl disable --now firewalld
systemctl disable --now dnsmasqsetenforce 0
dnf install -y ntpdate chrony
systemctl <span class="nb">enable</span> --now chronyd

<span class="c1">#docker install</span>
dnf install -y yum-utils device-mapper-persistent-data lvm2
curl  https://download.docker.com/linux/centos/docker-ce.repo -o /etc/yum.repos.d/docker-ce.repo
dnf config-manager --add-repo<span class="o">=</span>https://download.docker.com/linux/centos/docker-ce.repo
dnf makecache
curl -x socks5://192.168.1.118:3213 -O https://download.docker.com/linux/centos/7/x86_64/edge/Packages/containerd.io-1.2.6-3.3.el7.x86_64.rpm
dnf -y install containerd.io-1.2.6-3.3.el7.x86_64.rpm
dnf install docker-ce -y
systemctl <span class="nb">enable</span> --now docker
docker info

cat &gt; /etc/docker/daemon.json <span class="s">&lt;&lt; EOF
</span><span class="s">{
</span><span class="s">  &#34;exec-opts&#34;: [&#34;native.cgroupdriver=systemd&#34;],
</span><span class="s">  &#34;registry-mirrors&#34;: [&#34;https://dockerhub.azk8s.cn&#34;, &#34;https://docker.mirrors.ustc.edu.cn&#34;, &#34;http://hub-mirror.c.163.com/&#34;, &#34;https://registry.docker-cn.com&#34;], 
</span><span class="s">  &#34;storage-driver&#34;: &#34;overlay2&#34;,
</span><span class="s">  &#34;storage-opts&#34;: [&#34;overlay2.override_kernel_check=true&#34;],
</span><span class="s">  &#34;insecure-registries&#34;: [&#34;127.0.0.1/8&#34;],
</span><span class="s">  &#34;max-concurrent-downloads&#34;: 10,
</span><span class="s">  &#34;log-driver&#34;: &#34;json-file&#34;,
</span><span class="s">  &#34;log-level&#34;: &#34;warn&#34;,
</span><span class="s">  &#34;log-opts&#34;: {
</span><span class="s">    &#34;max-size&#34;: &#34;10m&#34;,
</span><span class="s">    &#34;max-file&#34;: &#34;3&#34;
</span><span class="s">    },
</span><span class="s">  &#34;data-root&#34;: &#34;/var/lib/docker&#34;
</span><span class="s">}
</span><span class="s">EOF</span>
systemctl daemon-reload
systemctl restart docker
systemctl <span class="nb">enable</span> docker

<span class="c1">#设置hostname   https://www.bbsmax.com/A/QW5YNkqqdm/</span>
hostnamectl set-hostname k8s-master01
<span class="c1">#设置hosts</span>
cat <span class="s">&lt;&lt;EOF &gt;&gt; /etc/hosts
</span><span class="s">192.168.1.241   k8s-master01
</span><span class="s">192.168.1.242   k8s-master02
</span><span class="s">192.168.1.243   k8s-master03
</span><span class="s">192.168.1.244   k8s-node01
</span><span class="s">192.168.1.11    k8s-master-lb
</span><span class="s">EOF</span>
lsmod <span class="p">|</span> grep -e ip_vs -e nf_conntrack_ipv4
hostnamectl set-hostname k8s-master01
hostnamectl set-hostname k8s-node01
swapoff -a <span class="o">&amp;&amp;</span> sysctl -w vm.swappiness<span class="o">=</span>0
vm.swappiness <span class="o">=</span> 0
ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
<span class="nb">echo</span> <span class="s1">&#39;Asia/Shanghai&#39;</span> /etc/timezone
ntpdate time2.aliyun.com
ssh-keygen -t rsa
<span class="c1">#配置免密</span>
ssh-keygen -t ed25519 -C <span class="s2">&#34;myki&#34;</span>
<span class="k">for</span> i in k8s-master01 k8s-master02 k8s-master03 k8s-node01<span class="p">;</span><span class="k">do</span> ssh-copy-id -i .ssh/id_ed25519.pub <span class="nv">$i</span><span class="p">;</span><span class="k">done</span>
dnf install wget jq psmisc vim net-tools yum-utils device-mapper-persistent-data lvm2 git -y

<span class="c1">#Master01下载安装文件</span>
git config --global http.proxy <span class="s1">&#39;socks5://192.168.1.118:3213&#39;</span>
git config --global https.proxy <span class="s1">&#39;socks5://192.168.1.118:3213&#39;</span>
git clone https://github.com/dotbalo/k8s-ha-install.git
git checkout manual-installation-v1.17.x


<span class="c1">#k8s组件安装</span>
wget https://storage.googleapis.com/kubernetes-release/release/v1.17.0/kubernetes-server-linux-amd64.tar.gz
wget https://github.com/etcd-io/etcd/releases/download/v3.3.18/etcd-v3.3.18-linux-amd64.tar.gz
tar -xf kubernetes-server-linux-amd64.tar.gz  --strip-components<span class="o">=</span><span class="m">3</span> -C /usr/local/bin kubernetes/server/bin/kube<span class="o">{</span>let,ctl,-apiserver,-controller-manager,-scheduler,-proxy<span class="o">}</span>
tar -zxvf etcd-v3.3.18-linux-amd64.tar.gz --strip-components<span class="o">=</span><span class="m">1</span> -C /usr/local/bin etcd-v3.3.18-linux-amd64/etcd<span class="o">{</span>,ctl<span class="o">}</span>
kubectl version
etcdctl -v

<span class="c1">#将组件发送到其他节点</span>
<span class="nv">MasterNodes</span><span class="o">=</span><span class="s1">&#39;k8s-master02 k8s-master03&#39;</span>
<span class="nv">WorkNodes</span><span class="o">=</span><span class="s1">&#39;k8s-node01&#39;</span>
<span class="k">for</span> NODE in <span class="nv">$MasterNodes</span><span class="p">;</span> <span class="k">do</span> <span class="nb">echo</span> <span class="nv">$NODE</span><span class="p">;</span> scp /usr/local/bin/kube<span class="o">{</span>let,ctl,-apiserver,-controller-manager,-scheduler,-proxy<span class="o">}</span> <span class="nv">$NODE</span>:/usr/local/bin/<span class="p">;</span> scp /usr/local/bin/etcd* <span class="nv">$NODE</span>:/usr/local/bin/<span class="p">;</span> <span class="k">done</span>
<span class="k">for</span> NODE in <span class="nv">$WorkNodes</span><span class="p">;</span> <span class="k">do</span>     scp /usr/local/bin/kube<span class="o">{</span>let,-proxy<span class="o">}</span> <span class="nv">$NODE</span>:/usr/local/bin/ <span class="p">;</span> <span class="k">done</span>

<span class="c1">#CNI安装，下载CNI组件</span>
wget  https://github.com/containernetworking/plugins/releases/download/v0.7.5/cni-plugins-amd64-v0.7.5.tgz
<span class="c1">#所有节点创建/opt/cni/bin目录</span>
mkdir -p /opt/cni/bin
tar -zxf cni-plugins-amd64-v0.7.5.tgz -C /opt/cni/bin
<span class="k">for</span> NODE in <span class="nv">$MasterNodes</span><span class="p">;</span> <span class="k">do</span>     ssh <span class="nv">$NODE</span> <span class="s1">&#39;mkdir -p /opt/cni/bin&#39;</span><span class="p">;</span>     scp /opt/cni/bin/* <span class="nv">$NODE</span>:/opt/cni/bin/<span class="p">;</span> <span class="k">done</span>
<span class="k">for</span> NODE in <span class="nv">$WorkNodes</span><span class="p">;</span> <span class="k">do</span>     ssh <span class="nv">$NODE</span> <span class="s1">&#39;mkdir -p /opt/cni/bin&#39;</span><span class="p">;</span>     scp /opt/cni/bin/* <span class="nv">$NODE</span>:/opt/cni/bin/<span class="p">;</span> <span class="k">done</span>


<span class="c1">#生成证书</span>
wget <span class="s2">&#34;https://pkg.cfssl.org/R1.2/cfssl_linux-amd64&#34;</span> -O /usr/local/bin/cfssl
wget <span class="s2">&#34;https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64&#34;</span> -O /usr/local/bin/cfssljson
wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -O /usr/local/bin/cfssl-certinfo
chmod +x /usr/local/bin/cfssl*

<span class="c1">#Master01节点生成etcd证书</span>
mkdir /etc/etcd/ssl -p
<span class="nb">cd</span> k8s-ha-install/
git checkout manual-installation-v1.17.x
<span class="nb">cd</span> pki/

cfssl gencert -initca etcd-ca-csr.json <span class="p">|</span> cfssljson -bare /etc/etcd/ssl/etcd-ca
cfssl gencert <span class="se">\</span>
   -ca<span class="o">=</span>/etc/etcd/ssl/etcd-ca.pem <span class="se">\</span>
   -ca-key<span class="o">=</span>/etc/etcd/ssl/etcd-ca-key.pem <span class="se">\</span>
   -config<span class="o">=</span>ca-config.json <span class="se">\</span>
   -hostname<span class="o">=</span>127.0.0.1,k8s-master01,k8s-master02,k8s-master03,192.168.1.241,192.168.1.242,192.168.1.243 <span class="se">\</span>
   -profile<span class="o">=</span>kubernetes <span class="se">\</span>
   etcd-csr.json <span class="p">|</span> cfssljson -bare /etc/etcd/ssl/etcd

<span class="c1">#将证书复制到其他节点</span>
<span class="k">for</span> NODE in <span class="nv">$MasterNodes</span><span class="p">;</span> <span class="k">do</span>
     ssh <span class="nv">$NODE</span> <span class="s2">&#34;mkdir -p /etc/etcd/ssl&#34;</span>
     <span class="k">for</span> FILE in etcd-ca-key.pem  etcd-ca.pem  etcd-key.pem  etcd.pem<span class="p">;</span> <span class="k">do</span>
       scp /etc/etcd/ssl/<span class="si">${</span><span class="nv">FILE</span><span class="si">}</span> <span class="nv">$NODE</span>:/etc/etcd/ssl/<span class="si">${</span><span class="nv">FILE</span><span class="si">}</span>
     <span class="k">done</span>
 <span class="k">done</span>

<span class="c1">#生成kubernetes证书 所有节点创建kubernetes相关目录</span>
mkdir -p /etc/kubernetes/pki
cfssl gencert -initca ca-csr.json <span class="p">|</span> cfssljson -bare /etc/kubernetes/pki/ca
cfssl gencert   -ca<span class="o">=</span>/etc/kubernetes/pki/ca.pem   -ca-key<span class="o">=</span>/etc/kubernetes/pki/ca-key.pem   -config<span class="o">=</span>ca-config.json   -hostname<span class="o">=</span>10.96.0.1,192.168.1.11,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,192.168.1.241,192.168.1.242,192.168.1.243   -profile<span class="o">=</span>kubernetes   apiserver-csr.json <span class="p">|</span> cfssljson -bare /etc/kubernetes/pki/apiserver
cfssl gencert   -initca front-proxy-ca-csr.json <span class="p">|</span> cfssljson -bare /etc/kubernetes/pki/front-proxy-ca
cfssl gencert   -ca<span class="o">=</span>/etc/kubernetes/pki/front-proxy-ca.pem   -ca-key<span class="o">=</span>/etc/kubernetes/pki/front-proxy-ca-key.pem   -config<span class="o">=</span>ca-config.json   -profile<span class="o">=</span>kubernetes   front-proxy-client-csr.json <span class="p">|</span> cfssljson -bare /etc/kubernetes/pki/front-proxy-client
cfssl gencert <span class="se">\</span>
   -ca<span class="o">=</span>/etc/kubernetes/pki/ca.pem <span class="se">\</span>
   -ca-key<span class="o">=</span>/etc/kubernetes/pki/ca-key.pem <span class="se">\</span>
   -config<span class="o">=</span>ca-config.json <span class="se">\</span>
   -profile<span class="o">=</span>kubernetes <span class="se">\</span>
   manager-csr.json <span class="p">|</span> cfssljson -bare /etc/kubernetes/pki/controller-manager

kubectl config set-cluster kubernetes <span class="se">\</span>
     --certificate-authority<span class="o">=</span>/etc/kubernetes/pki/ca.pem <span class="se">\</span>
     --embed-certs<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
     --server<span class="o">=</span>https://192.168.1.11:8443 <span class="se">\</span>
     --kubeconfig<span class="o">=</span>/etc/kubernetes/controller-manager.kubeconfig
kubectl config set-context system:kube-controller-manager@kubernetes <span class="se">\</span>
    --cluster<span class="o">=</span>kubernetes <span class="se">\</span>
    --user<span class="o">=</span>system:kube-controller-manager <span class="se">\</span>
    --kubeconfig<span class="o">=</span>/etc/kubernetes/controller-manager.kubeconfig

kubectl config use-context system:kube-controller-manager@kubernetes <span class="se">\</span>
    --kubeconfig<span class="o">=</span>/etc/kubernetes/controller-manager.kubeconfig


kubectl config set-credentials system:kube-controller-manager <span class="se">\</span>
     --client-certificate<span class="o">=</span>/etc/kubernetes/pki/controller-manager.pem <span class="se">\</span>
     --client-key<span class="o">=</span>/etc/kubernetes/pki/controller-manager-key.pem <span class="se">\</span>
     --embed-certs<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
     --kubeconfig<span class="o">=</span>/etc/kubernetes/controller-manager.kubeconfig

kubectl config set-context system:kube-controller-manager@kubernetes <span class="se">\</span>
     --cluster<span class="o">=</span>kubernetes <span class="se">\</span>
     --user<span class="o">=</span>system:kube-controller-manager <span class="se">\</span>
     --kubeconfig<span class="o">=</span>/etc/kubernetes/controller-manager.kubeconfig

kubectl config use-context system:kube-controller-manager@kubernetes <span class="se">\</span>
     --kubeconfig<span class="o">=</span>/etc/kubernetes/controller-manager.kubeconfig


cfssl gencert <span class="se">\</span>
   -ca<span class="o">=</span>/etc/kubernetes/pki/ca.pem <span class="se">\</span>
   -ca-key<span class="o">=</span>/etc/kubernetes/pki/ca-key.pem <span class="se">\</span>
   -config<span class="o">=</span>ca-config.json <span class="se">\</span>
   -profile<span class="o">=</span>kubernetes <span class="se">\</span>
   scheduler-csr.json <span class="p">|</span> cfssljson -bare /etc/kubernetes/pki/scheduler
kubectl config set-cluster kubernetes <span class="se">\</span>
     --certificate-authority<span class="o">=</span>/etc/kubernetes/pki/ca.pem <span class="se">\</span>
     --embed-certs<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
     --server<span class="o">=</span>https://192.168.1.11:8443 <span class="se">\</span>
     --kubeconfig<span class="o">=</span>/etc/kubernetes/scheduler.kubeconfig
kubectl config set-credentials system:kube-scheduler <span class="se">\</span>
     --client-certificate<span class="o">=</span>/etc/kubernetes/pki/scheduler.pem <span class="se">\</span>
     --client-key<span class="o">=</span>/etc/kubernetes/pki/scheduler-key.pem <span class="se">\</span>
     --embed-certs<span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
     --kubeconfig<span class="o">=</span>/etc/kubernetes/scheduler.kubeconfig
kubectl config set-context system:kube-scheduler@kubernetes <span class="se">\</span>
     --cluster<span class="o">=</span>kubernetes <span class="se">\</span>
     --user<span class="o">=</span>system:kube-scheduler <span class="se">\</span>
     --kubeconfig<span class="o">=</span>/etc/kubernetes/scheduler.kubeconfig
kubectl config use-context system:kube-scheduler@kubernetes <span class="se">\</span>
     --kubeconfig<span class="o">=</span>/etc/kubernetes/scheduler.kubeconfig

cfssl gencert <span class="se">\</span>
   -ca<span class="o">=</span>/etc/kubernetes/pki/ca.pem <span class="se">\</span>
   -ca-key<span class="o">=</span>/etc/kubernetes/pki/ca-key.pem <span class="se">\</span>
   -config<span class="o">=</span>ca-config.json <span class="se">\</span>
   -profile<span class="o">=</span>kubernetes <span class="se">\</span>
   admin-csr.json <span class="p">|</span> cfssljson -bare /etc/kubernetes/pki/admin
kubectl config set-cluster kubernetes     --certificate-authority<span class="o">=</span>/etc/kubernetes/pki/ca.pem     --embed-certs<span class="o">=</span><span class="nb">true</span>     --server<span class="o">=</span>https://192.168.1.11:8443     --kubeconfig<span class="o">=</span>/etc/kubernetes/admin.kubeconfig
kubectl config set-credentials kubernetes-admin     --client-certificate<span class="o">=</span>/etc/kubernetes/pki/admin.pem     --client-key<span class="o">=</span>/etc/kubernetes/pki/admin-key.pem     --embed-certs<span class="o">=</span><span class="nb">true</span>     --kubeconfig<span class="o">=</span>/etc/kubernetes/admin.kubeconfig
kubectl config set-context kubernetes-admin@kubernetes     --cluster<span class="o">=</span>kubernetes     --user<span class="o">=</span>kubernetes-admin     --kubeconfig<span class="o">=</span>/etc/kubernetes/admin.kubeconfig
kubectl config use-context kubernetes-admin@kubernetes     --kubeconfig<span class="o">=</span>/etc/kubernetes/admin.kubeconfig

<span class="k">for</span> NODE in k8s-master01 k8s-master02 k8s-master03<span class="p">;</span> <span class="k">do</span>
     <span class="se">\c</span>p kubelet-csr.json kubelet-<span class="nv">$NODE</span>-csr.json<span class="p">;</span>
     sed -i <span class="s2">&#34;</span><span class="s2">s/\$NODE/</span><span class="nv">$NODE</span><span class="s2">/g</span><span class="s2">&#34;</span> kubelet-<span class="nv">$NODE</span>-csr.json<span class="p">;</span>
     cfssl gencert <span class="se">\</span>
       -ca<span class="o">=</span>/etc/kubernetes/pki/ca.pem <span class="se">\</span>
       -ca-key<span class="o">=</span>/etc/kubernetes/pki/ca-key.pem <span class="se">\</span>
       -config<span class="o">=</span>ca-config.json <span class="se">\</span>
       -hostname<span class="o">=</span><span class="nv">$NODE</span> <span class="se">\</span>
       -profile<span class="o">=</span>kubernetes <span class="se">\</span>
       kubelet-<span class="nv">$NODE</span>-csr.json <span class="p">|</span> cfssljson -bare /etc/kubernetes/pki/kubelet-<span class="nv">$NODE</span><span class="p">;</span>
     rm -f kubelet-<span class="nv">$NODE</span>-csr.json
   <span class="k">done</span>

<span class="k">for</span> NODE in k8s-master01 k8s-master02 k8s-master03<span class="p">;</span> <span class="k">do</span>
     ssh <span class="nv">$NODE</span> <span class="s2">&#34;mkdir -p /etc/kubernetes/pki&#34;</span>
     scp /etc/kubernetes/pki/ca.pem <span class="nv">$NODE</span>:/etc/kubernetes/pki/ca.pem
     scp /etc/kubernetes/pki/kubelet-<span class="nv">$NODE</span>-key.pem <span class="nv">$NODE</span>:/etc/kubernetes/pki/kubelet-key.pem
     scp /etc/kubernetes/pki/kubelet-<span class="nv">$NODE</span>.pem <span class="nv">$NODE</span>:/etc/kubernetes/pki/kubelet.pem
     rm -f /etc/kubernetes/pki/kubelet-<span class="nv">$NODE</span>-key.pem /etc/kubernetes/pki/kubelet-<span class="nv">$NODE</span>.pem
 <span class="k">done</span>


<span class="k">for</span> NODE in k8s-master01 k8s-master02 k8s-master03<span class="p">;</span> <span class="k">do</span>
     ssh <span class="nv">$NODE</span> <span class="s2">&#34;</span><span class="s2">cd /etc/kubernetes/pki &amp;&amp; \
</span><span class="s2">       kubectl config set-cluster kubernetes \
</span><span class="s2">         --certificate-authority=/etc/kubernetes/pki/ca.pem \
</span><span class="s2">         --embed-certs=true \
</span><span class="s2">         --server=https://192.168.1.11:8443 \
</span><span class="s2">         --kubeconfig=/etc/kubernetes/kubelet.kubeconfig &amp;&amp; \
</span><span class="s2">       kubectl config set-credentials system:node:</span><span class="si">${</span><span class="nv">NODE</span><span class="si">}</span><span class="s2"> \
</span><span class="s2">         --client-certificate=/etc/kubernetes/pki/kubelet.pem \
</span><span class="s2">         --client-key=/etc/kubernetes/pki/kubelet-key.pem \
</span><span class="s2">         --embed-certs=true \
</span><span class="s2">         --kubeconfig=/etc/kubernetes/kubelet.kubeconfig &amp;&amp; \
</span><span class="s2">       kubectl config set-context system:node:</span><span class="si">${</span><span class="nv">NODE</span><span class="si">}</span><span class="s2">@kubernetes \
</span><span class="s2">         --cluster=kubernetes \
</span><span class="s2">         --user=system:node:</span><span class="si">${</span><span class="nv">NODE</span><span class="si">}</span><span class="s2"> \
</span><span class="s2">         --kubeconfig=/etc/kubernetes/kubelet.kubeconfig &amp;&amp; \
</span><span class="s2">       kubectl config use-context system:node:</span><span class="si">${</span><span class="nv">NODE</span><span class="si">}</span><span class="s2">@kubernetes \
</span><span class="s2">         --kubeconfig=/etc/kubernetes/kubelet.kubeconfig</span><span class="s2">&#34;</span>
 <span class="k">done</span>


<span class="c1">#创建ServiceAccount Key</span>
openssl genrsa -out /etc/kubernetes/pki/sa.key 2048
openssl rsa -in /etc/kubernetes/pki/sa.key -pubout -out /etc/kubernetes/pki/sa.pub
<span class="k">for</span> NODE in k8s-master02 k8s-master03<span class="p">;</span> <span class="k">do</span> 
<span class="k">for</span> FILE in <span class="k">$(</span>ls /etc/kubernetes/pki <span class="p">|</span> grep -v etcd<span class="k">)</span><span class="p">;</span> <span class="k">do</span> 
scp /etc/kubernetes/pki/<span class="si">${</span><span class="nv">FILE</span><span class="si">}</span> <span class="nv">$NODE</span>:/etc/kubernetes/pki/<span class="si">${</span><span class="nv">FILE</span><span class="si">}</span><span class="p">;</span>
<span class="k">done</span><span class="p">;</span> 
<span class="k">for</span> FILE in admin.kubeconfig controller-manager.kubeconfig scheduler.kubeconfig<span class="p">;</span> <span class="k">do</span> 
scp /etc/kubernetes/<span class="si">${</span><span class="nv">FILE</span><span class="si">}</span> <span class="nv">$NODE</span>:/etc/kubernetes/<span class="si">${</span><span class="nv">FILE</span><span class="si">}</span><span class="p">;</span>
<span class="k">done</span><span class="p">;</span>
<span class="k">done</span>

<span class="c1">#etcd配置大致相同，注意修改每个Master节点的etcd配置的主机名和IP地址</span>
vi /etc/etcd/etcd.config.yml
name: <span class="s1">&#39;k8s-master01&#39;</span>
data-dir: /var/lib/etcd
wal-dir: /var/lib/etcd/wal
snapshot-count: 5000
heartbeat-interval: 100
election-timeout: 1000
quota-backend-bytes: 0
listen-peer-urls: <span class="s1">&#39;https://192.168.1.241:2380&#39;</span>
listen-client-urls: <span class="s1">&#39;https://192.168.1.241:2379,http://127.0.0.1:2379&#39;</span>
max-snapshots: 3
max-wals: 5
cors:
initial-advertise-peer-urls: <span class="s1">&#39;https://192.168.1.241:2380&#39;</span>
advertise-client-urls: <span class="s1">&#39;https://192.168.1.241:2379&#39;</span>
discovery:
discovery-fallback: <span class="s1">&#39;proxy&#39;</span>
discovery-proxy:
discovery-srv:
initial-cluster: <span class="s1">&#39;k8s-master01=https://192.168.1.241:2380,k8s-master02=https://192.168.1.242:2380,k8s-master03=https://192.168.1.243:2380&#39;</span>
initial-cluster-token: <span class="s1">&#39;etcd-k8s-cluster&#39;</span>
initial-cluster-state: <span class="s1">&#39;new&#39;</span>
strict-reconfig-check: <span class="nb">false</span>
enable-v2: <span class="nb">true</span>
enable-pprof: <span class="nb">true</span>
proxy: <span class="s1">&#39;off&#39;</span>
proxy-failure-wait: 5000
proxy-refresh-interval: 30000
proxy-dial-timeout: 1000
proxy-write-timeout: 5000
proxy-read-timeout: 0
client-transport-security:
  ca-file: <span class="s1">&#39;/etc/kubernetes/pki/etcd/etcd-ca.pem&#39;</span>
  cert-file: <span class="s1">&#39;/etc/kubernetes/pki/etcd/etcd.pem&#39;</span>
  key-file: <span class="s1">&#39;/etc/kubernetes/pki/etcd/etcd-key.pem&#39;</span>
  client-cert-auth: <span class="nb">true</span>
  trusted-ca-file: <span class="s1">&#39;/etc/kubernetes/pki/etcd/etcd-ca.pem&#39;</span>
  auto-tls: <span class="nb">true</span>
peer-transport-security:
  ca-file: <span class="s1">&#39;/etc/kubernetes/pki/etcd/etcd-ca.pem&#39;</span>
  cert-file: <span class="s1">&#39;/etc/kubernetes/pki/etcd/etcd.pem&#39;</span>
  key-file: <span class="s1">&#39;/etc/kubernetes/pki/etcd/etcd-key.pem&#39;</span>
  peer-client-cert-auth: <span class="nb">true</span>
  trusted-ca-file: <span class="s1">&#39;/etc/kubernetes/pki/etcd/etcd-ca.pem&#39;</span>
  auto-tls: <span class="nb">true</span>
debug: <span class="nb">false</span>
log-package-levels:
log-output: default
force-new-cluster: <span class="nb">false</span>

vi /usr/lib/systemd/system/etcd.service
<span class="o">[</span>Unit<span class="o">]</span>
<span class="nv">Description</span><span class="o">=</span>Etcd Service
<span class="nv">Documentation</span><span class="o">=</span>https://coreos.com/etcd/docs/latest/
<span class="nv">After</span><span class="o">=</span>network.target

<span class="o">[</span>Service<span class="o">]</span>
<span class="nv">Type</span><span class="o">=</span>notify
<span class="nv">ExecStart</span><span class="o">=</span>/usr/local/bin/etcd --config-file<span class="o">=</span>/etc/etcd/etcd.config.yml
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">RestartSec</span><span class="o">=</span>10
<span class="nv">LimitNOFILE</span><span class="o">=</span>65536

<span class="o">[</span>Install<span class="o">]</span>
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
<span class="nv">Alias</span><span class="o">=</span>etcd3.service

mkdir /etc/kubernetes/pki/etcd
ln -s /etc/etcd/ssl/* /etc/kubernetes/pki/etcd/
systemctl daemon-reload
systemctl <span class="nb">enable</span> --now etcd
<span class="c1">#安装cfssl https://www.cnblogs.com/dukuan/p/12104600.html  https://ngames-dev.cn/2019/08/25/%E4%BA%8C%E8%BF%9B%E5%88%B6k8s%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/</span>
wget https://storage.googleapis.com/kubernetes-release/release/v1.17.0/kubernetes-server-linux-amd64.tar.gz

<span class="c1">#etcd 如果初始化失败  https://blog.51cto.com/14143894/2428545</span>
systemctl stop etcd.service
rm -rf /var/lib/etcd/*
systemctl daemon-reload
systemctl start etcd.service

<span class="c1">#检查集群etcd监控状态</span>
<span class="c1">#export ETCDCTL_API=3</span>
etcdctl --ca-file<span class="o">=</span>/etc/kubernetes/pki/etcd/etcd-ca.pem --cert-file<span class="o">=</span>/etc/kubernetes/pki/etcd/etcd.pem --key-file<span class="o">=</span>/etc/kubernetes/pki/etcd/etcd-key.pem member list
etcdctl --ca-file<span class="o">=</span>/etc/kubernetes/pki/etcd/etcd-ca.pem --cert-file<span class="o">=</span>/etc/kubernetes/pki/etcd/etcd.pem --key-file<span class="o">=</span>/etc/kubernetes/pki/etcd/etcd-key.pem cluster-health

<span class="c1">#在所有master节点上执行高可用配置</span>
yum install keepalived haproxy -y
vi /etc/haproxy/haproxy.cfg

global
  maxconn  2000
  ulimit-n  16384
  log  127.0.0.1 local0 err
  stats timeout 30s

defaults
  log global
  mode  http
  option  httplog
  timeout connect 5000
  timeout client  50000
  timeout server  50000
  timeout http-request 15s
  timeout http-keep-alive 15s

frontend monitor-in
  <span class="nb">bind</span> *:33305
  mode http
  option httplog
  monitor-uri /monitor

listen stats
  <span class="nb">bind</span>    *:8006
  mode    http
  stats   <span class="nb">enable</span>
  stats   hide-version
  stats   uri       /stats
  stats   refresh   30s
  stats   realm     Haproxy<span class="se">\ </span>Statistics
  stats   auth      admin:admin

frontend k8s-master
  <span class="nb">bind</span> 0.0.0.0:8443
  <span class="nb">bind</span> 127.0.0.1:8443
  mode tcp
  option tcplog
  tcp-request inspect-delay 5s
  default_backend k8s-master

backend k8s-master
  mode tcp
  option tcplog
  option tcp-check
  balance roundrobin
  default-server inter 10s downinter 5s rise <span class="m">2</span> fall <span class="m">2</span> slowstart 60s maxconn <span class="m">250</span> maxqueue <span class="m">256</span> weight 100
  server k8s-master01    192.168.1.241:6443  check
  server k8s-master02    192.168.1.242:6443  check
  server k8s-master03    192.168.1.243:6443  check

vim /etc/keepalived/keepalived.conf
! Configuration File <span class="k">for</span> keepalived
global_defs <span class="o">{</span>
    router_id LVS_DEVEL
<span class="o">}</span>
vrrp_script chk_apiserver <span class="o">{</span>
    script <span class="s2">&#34;/etc/keepalived/check_apiserver.sh&#34;</span>
    interval 2
    weight -5
    fall <span class="m">3</span>  
    rise 2
<span class="o">}</span>
vrrp_instance VI_1 <span class="o">{</span>
    state MASTER
    interface eth0
    mcast_src_ip 192.168.1.241
    virtual_router_id 241
    priority 100
    advert_int 2
    authentication <span class="o">{</span>
        auth_type PASS
        auth_pass K8SHA_KA_AUTH
    <span class="o">}</span>
    virtual_ipaddress <span class="o">{</span>
        192.168.1.11
    <span class="o">}</span>
    track_script <span class="o">{</span>
      chk_apiserver 
<span class="o">}</span> <span class="o">}</span>

vi /etc/keepalived/check_apiserver.sh
<span class="c1">#!/bin/bash</span>

<span class="nv">err</span><span class="o">=</span>0
<span class="k">for</span> k in <span class="k">$(</span>seq <span class="m">1</span> 5<span class="k">)</span>
<span class="k">do</span>
    <span class="nv">check_code</span><span class="o">=</span><span class="k">$(</span>pgrep kube-apiserver<span class="k">)</span>
    <span class="k">if</span> <span class="o">[</span><span class="o">[</span> <span class="nv">$check_code</span> <span class="o">=</span><span class="o">=</span> <span class="s2">&#34;&#34;</span> <span class="o">]</span><span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nv">err</span><span class="o">=</span><span class="k">$(</span>expr <span class="nv">$err</span> + 1<span class="k">)</span>
        sleep 5
        <span class="k">continue</span>
    <span class="k">else</span>
        <span class="nv">err</span><span class="o">=</span>0
        <span class="nb">break</span>
    <span class="k">fi</span>
<span class="k">done</span>

<span class="k">if</span> <span class="o">[</span><span class="o">[</span> <span class="nv">$err</span> !<span class="o">=</span> <span class="s2">&#34;0&#34;</span> <span class="o">]</span><span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&#34;systemctl stop keepalived&#34;</span>
    /usr/bin/systemctl stop keepalived
    <span class="nb">exit</span> 1
<span class="k">else</span>
    <span class="nb">exit</span> 0
<span class="k">fi</span>
systemctl <span class="nb">enable</span> --now haproxy
systemctl <span class="nb">enable</span> --now keepalived


<span class="c1">#Kubernetes组件配置</span>
mkdir -p /etc/kubernetes/manifests/ /etc/systemd/system/kubelet.service.d /var/lib/kubelet /var/log/kubernetes
<span class="nb">echo</span> <span class="s1">&#39;[Unit]
</span><span class="s1">Description=Kubernetes API Server
</span><span class="s1">Documentation=https://github.com/kubernetes/kubernetes
</span><span class="s1">After=network.target
</span><span class="s1">
</span><span class="s1">[Service]
</span><span class="s1">ExecStart=/usr/local/bin/kube-apiserver \
</span><span class="s1">      --v=2  \
</span><span class="s1">      --logtostderr=true  \
</span><span class="s1">      --allow-privileged=true  \
</span><span class="s1">      --bind-address=0.0.0.0  \
</span><span class="s1">      --secure-port=6443  \
</span><span class="s1">      --insecure-port=0  \
</span><span class="s1">      --advertise-address=192.168.1.11 \
</span><span class="s1">      --service-cluster-ip-range=10.96.0.0/12  \
</span><span class="s1">      --service-node-port-range=30000-50000  \
</span><span class="s1">      --etcd-servers=https://192.168.1.241:2379,https://192.168.1.242:2379,https://192.168.1.243:2379 \
</span><span class="s1">      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \
</span><span class="s1">      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \
</span><span class="s1">      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \
</span><span class="s1">      --client-ca-file=/etc/kubernetes/pki/ca.pem  \
</span><span class="s1">      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \
</span><span class="s1">      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \
</span><span class="s1">      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \
</span><span class="s1">      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \
</span><span class="s1">      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \
</span><span class="s1">      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \
</span><span class="s1">      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \
</span><span class="s1">      --authorization-mode=Node,RBAC  \
</span><span class="s1">      --enable-bootstrap-token-auth=true  \
</span><span class="s1">      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \
</span><span class="s1">      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \
</span><span class="s1">      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \
</span><span class="s1">      --requestheader-allowed-names=aggregator  \
</span><span class="s1">      --requestheader-group-headers=X-Remote-Group  \
</span><span class="s1">      --requestheader-extra-headers-prefix=X-Remote-Extra-  \
</span><span class="s1">      --requestheader-username-headers=X-Remote-User  \
</span><span class="s1">      --token-auth-file=/etc/kubernetes/token.csv
</span><span class="s1">
</span><span class="s1">Restart=on-failure
</span><span class="s1">RestartSec=10s
</span><span class="s1">LimitNOFILE=65535
</span><span class="s1">
</span><span class="s1">[Install]
</span><span class="s1">WantedBy=multi-user.target&#39;</span> &gt; /usr/lib/systemd/system/kube-apiserver.service 
vim /etc/kubernetes/token.csv
cat !$
cat /etc/kubernetes/token.csv
d7d356746b508a1a478e49968fba7947,kubelet-bootstrap,10001,<span class="s2">&#34;system:kubelet-bootstrap&#34;</span>
systemctl daemon-reload <span class="o">&amp;&amp;</span> systemctl <span class="nb">enable</span> --now kube-apiserver
curl -k https://192.168.1.11:8443

<span class="c1">#所有Master节点配置kube-controller-manager service</span>
<span class="nb">echo</span> <span class="s1">&#39;
</span><span class="s1">[Unit]
</span><span class="s1">Description=Kubernetes Controller Manager
</span><span class="s1">Documentation=https://github.com/kubernetes/kubernetes
</span><span class="s1">After=network.target
</span><span class="s1">
</span><span class="s1">[Service]
</span><span class="s1">ExecStart=/usr/local/bin/kube-controller-manager \
</span><span class="s1">      --v=2 \
</span><span class="s1">      --logtostderr=true \
</span><span class="s1">      --address=127.0.0.1 \
</span><span class="s1">      --root-ca-file=/etc/kubernetes/pki/ca.pem \
</span><span class="s1">      --cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem \
</span><span class="s1">      --cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem \
</span><span class="s1">      --service-account-private-key-file=/etc/kubernetes/pki/sa.key \
</span><span class="s1">      --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig \
</span><span class="s1">      --leader-elect=true \
</span><span class="s1">      --use-service-account-credentials=true \
</span><span class="s1">      --node-monitor-grace-period=40s \
</span><span class="s1">      --node-monitor-period=5s \
</span><span class="s1">      --pod-eviction-timeout=2m0s \
</span><span class="s1">      --controllers=*,bootstrapsigner,tokencleaner \
</span><span class="s1">      --allocate-node-cidrs=true \
</span><span class="s1">      --cluster-cidr=10.244.0.0/16 \
</span><span class="s1">      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem \
</span><span class="s1">      --node-cidr-mask-size=24
</span><span class="s1">      
</span><span class="s1">Restart=always
</span><span class="s1">RestartSec=10s
</span><span class="s1">
</span><span class="s1">[Install]
</span><span class="s1">WantedBy=multi-user.target&#39;</span> &gt; /usr/lib/systemd/system/kube-controller-manager.service
systemctl daemon-reload
systemctl <span class="nb">enable</span> --now kube-controller-manager

<span class="c1">#kube-scheduler service</span>
<span class="nb">echo</span> <span class="s1">&#39;
</span><span class="s1">[Unit]
</span><span class="s1">Description=Kubernetes Scheduler
</span><span class="s1">Documentation=https://github.com/kubernetes/kubernetes
</span><span class="s1">After=network.target
</span><span class="s1">
</span><span class="s1">[Service]
</span><span class="s1">ExecStart=/usr/local/bin/kube-scheduler \
</span><span class="s1">      --v=2 \
</span><span class="s1">      --logtostderr=true \
</span><span class="s1">      --address=127.0.0.1 \
</span><span class="s1">      --leader-elect=true \
</span><span class="s1">      --kubeconfig=/etc/kubernetes/scheduler.kubeconfig
</span><span class="s1">
</span><span class="s1">Restart=always
</span><span class="s1">RestartSec=10s
</span><span class="s1">
</span><span class="s1">[Install]
</span><span class="s1">WantedBy=multi-user.target&#39;</span> &gt; /usr/lib/systemd/system/kube-scheduler.service
systemctl daemon-reload
systemctl <span class="nb">enable</span> --now kube-scheduler

<span class="c1">#TLS Bootstrapping配置 在Master01创建bootstrap</span>
kubectl config set-cluster kubernetes     --certificate-authority<span class="o">=</span>/etc/kubernetes/pki/ca.pem     --embed-certs<span class="o">=</span><span class="nb">true</span>     --server<span class="o">=</span>https://192.168.1.11:8443     --kubeconfig<span class="o">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig
kubectl config set-credentials tls-bootstrap-token-user     --token<span class="o">=</span>c8ad9c.2e4d610cf3e7426e --kubeconfig<span class="o">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig
kubectl config set-context tls-bootstrap-token-user@kubernetes     --cluster<span class="o">=</span>kubernetes     --user<span class="o">=</span>tls-bootstrap-token-user     --kubeconfig<span class="o">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig
kubectl config use-context tls-bootstrap-token-user@kubernetes     --kubeconfig<span class="o">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig

<span class="c1">#在Master01创建bootstrap</span>
cp /etc/kubernetes/admin.kubeconfig /root/.kube/config
<span class="nb">cd</span> ../bootstrap/
kubectl create -f bootstrap.secret.yaml


<span class="k">for</span> NODE in k8s-node01 <span class="p">;</span> <span class="k">do</span>
     ssh <span class="nv">$NODE</span> mkdir -p /etc/kubernetes/pki /etc/etcd/ssl /etc/etcd/ssl
     <span class="k">for</span> FILE in etcd-ca.pem etcd.pem etcd-key.pem<span class="p">;</span> <span class="k">do</span>
       scp /etc/etcd/ssl/<span class="nv">$FILE</span> <span class="nv">$NODE</span>:/etc/etcd/ssl/
     <span class="k">done</span>
     <span class="k">for</span> FILE in pki/ca.pem pki/ca-key.pem pki/front-proxy-ca.pem bootstrap-kubelet.kubeconfig<span class="p">;</span> <span class="k">do</span>
       scp /etc/kubernetes/<span class="nv">$FILE</span> <span class="nv">$NODE</span>:/etc/kubernetes/<span class="si">${</span><span class="nv">FILE</span><span class="si">}</span>
 <span class="k">done</span>
 <span class="k">done</span>

<span class="c1">#所有Node节点创建相关目录</span>
mkdir -p /var/lib/kubelet /var/log/kubernetes /etc/systemd/system/kubelet.service.d /etc/kubernetes/manifests/
<span class="c1">#所有节点配置kubelet service（Master节点不部署Pod也可无需配置）</span>
vim  /usr/lib/systemd/system/kubelet.service
<span class="o">[</span>Unit<span class="o">]</span>
<span class="nv">Description</span><span class="o">=</span>Kubernetes Kubelet
<span class="nv">Documentation</span><span class="o">=</span>https://github.com/kubernetes/kubernetes
<span class="nv">After</span><span class="o">=</span>docker.service
<span class="nv">Requires</span><span class="o">=</span>docker.service
 
<span class="o">[</span>Service<span class="o">]</span>
<span class="nv">ExecStart</span><span class="o">=</span>/usr/local/bin/kubelet
 
<span class="nv">Restart</span><span class="o">=</span>always
<span class="nv">StartLimitInterval</span><span class="o">=</span>0
<span class="nv">RestartSec</span><span class="o">=</span>10
 
<span class="o">[</span>Install<span class="o">]</span>
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target

vim  /etc/systemd/system/kubelet.service.d/10-kubelet.conf
<span class="o">[</span>Service<span class="o">]</span>
<span class="nv">Environment</span><span class="o">=</span><span class="s2">&#34;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig --kubeconfig=/etc/kubernetes/kubelet.kubeconfig --cgroup-driver=systemd&#34;</span>
<span class="nv">Environment</span><span class="o">=</span><span class="s2">&#34;KUBELET_SYSTEM_ARGS=--network-plugin=cni --cni-conf-dir=/etc/cni/net.d --cni-bin-dir=/opt/cni/bin&#34;</span>
<span class="nv">Environment</span><span class="o">=</span><span class="s2">&#34;KUBELET_CONFIG_ARGS=--config=/etc/kubernetes/kubelet-conf.yml&#34;</span>
<span class="nv">Environment</span><span class="o">=</span><span class="s2">&#34;KUBELET_EXTRA_ARGS=--node-labels=node.kubernetes.io/node=&#39;&#39; --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:3.1&#34;</span>
<span class="nv">ExecStart</span><span class="o">=</span>
<span class="nv">ExecStart</span><span class="o">=</span>/usr/local/bin/kubelet <span class="nv">$KUBELET_KUBECONFIG_ARGS</span> <span class="nv">$KUBELET_CONFIG_ARGS</span> <span class="nv">$KUBELET_SYSTEM_ARGS</span> <span class="nv">$KUBELET_EXTRA_ARGS</span>

vi /etc/kubernetes/kubelet-conf.yml
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
address: 0.0.0.0
port: 10250
readOnlyPort: 10255
authentication:
  anonymous:
    enabled: <span class="nb">false</span>
  webhook:
    cacheTTL: 2m0s
    enabled: <span class="nb">true</span>
  x509:
    clientCAFile: /etc/kubernetes/pki/ca.pem
authorization:
  mode: Webhook
  webhook:
    cacheAuthorizedTTL: 5m0s
    cacheUnauthorizedTTL: 30s
cgroupDriver: cgroupfs
cgroupsPerQOS: <span class="nb">true</span>
clusterDNS:
- 10.96.0.10
clusterDomain: cluster.local
containerLogMaxFiles: 5
containerLogMaxSize: 10Mi
contentType: application/vnd.kubernetes.protobuf
cpuCFSQuota: <span class="nb">true</span>
cpuManagerPolicy: none
cpuManagerReconcilePeriod: 10s
enableControllerAttachDetach: <span class="nb">true</span>
enableDebuggingHandlers: <span class="nb">true</span>
enforceNodeAllocatable:
- pods
eventBurst: 10
eventRecordQPS: 5
evictionHard:
  imagefs.available: 15%
  memory.available: 100Mi
  nodefs.available: 10%
  nodefs.inodesFree: 5%
evictionPressureTransitionPeriod: 5m0s
failSwapOn: <span class="nb">true</span>
fileCheckFrequency: 20s
hairpinMode: promiscuous-bridge
healthzBindAddress: 127.0.0.1
healthzPort: 10248
httpCheckFrequency: 20s
imageGCHighThresholdPercent: 85
imageGCLowThresholdPercent: 80
imageMinimumGCAge: 2m0s
iptablesDropBit: 15
iptablesMasqueradeBit: 14
kubeAPIBurst: 10
kubeAPIQPS: 5
makeIPTablesUtilChains: <span class="nb">true</span>
maxOpenFiles: 1000000
maxPods: 110
nodeStatusUpdateFrequency: 10s
oomScoreAdj: -999
podPidsLimit: -1
registryBurst: 10
registryPullQPS: 5
resolvConf: /etc/resolv.conf
rotateCertificates: <span class="nb">true</span>
runtimeRequestTimeout: 2m0s
serializeImagePulls: <span class="nb">true</span>
staticPodPath: /etc/kubernetes/manifests
streamingConnectionIdleTimeout: 4h0m0s
syncFrequency: 1m0s
volumeStatsAggPeriod: 1m0s

systemctl daemon-reload
systemctl <span class="nb">enable</span> --now kubelet


<span class="c1">#Kube-Proxy配置</span>
<span class="nb">cd</span> /root/k8s-ha-install
kubectl -n kube-system create serviceaccount kube-proxy
kubectl create clusterrolebinding system:kube-proxy         --clusterrole system:node-proxier         --serviceaccount kube-system:kube-proxy
<span class="nv">SECRET</span><span class="o">=</span><span class="k">$(</span>kubectl -n kube-system get sa/kube-proxy <span class="se">\</span>
    --output<span class="o">=</span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.secrets[0].name}&#39;</span><span class="k">)</span>
<span class="nv">JWT_TOKEN</span><span class="o">=</span><span class="k">$(</span>kubectl -n kube-system get secret/<span class="nv">$SECRET</span> <span class="se">\</span>
--output<span class="o">=</span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.data.token}&#39;</span> <span class="p">|</span> base64 -d<span class="k">)</span>
<span class="nv">PKI_DIR</span><span class="o">=</span>/etc/kubernetes/pki
<span class="nv">K8S_DIR</span><span class="o">=</span>/etc/kubernetes
kubectl config set-cluster kubernetes     --certificate-authority<span class="o">=</span>/etc/kubernetes/pki/ca.pem     --embed-certs<span class="o">=</span><span class="nb">true</span>     --server<span class="o">=</span>https://192.168.1.11:8443     --kubeconfig<span class="o">=</span><span class="si">${</span><span class="nv">K8S_DIR</span><span class="si">}</span>/kube-proxy.kubeconfig
kubectl config set-credentials kubernetes     --token<span class="o">=</span><span class="si">${</span><span class="nv">JWT_TOKEN</span><span class="si">}</span>     --kubeconfig<span class="o">=</span>/etc/kubernetes/kube-proxy.kubeconfig
kubectl config set-context kubernetes     --cluster<span class="o">=</span>kubernetes     --user<span class="o">=</span>kubernetes     --kubeconfig<span class="o">=</span>/etc/kubernetes/kube-proxy.kubeconfig
kubectl config use-context kubernetes     --kubeconfig<span class="o">=</span>/etc/kubernetes/kube-proxy.kubeconfig

<span class="c1">#赋值Service文件</span>
<span class="k">for</span> NODE in k8s-master01 k8s-master02 k8s-master03<span class="p">;</span> <span class="k">do</span>
     scp <span class="si">${</span><span class="nv">K8S_DIR</span><span class="si">}</span>/kube-proxy.kubeconfig <span class="nv">$NODE</span>:/etc/kubernetes/kube-proxy.kubeconfig
     scp kube-proxy/kube-proxy.conf <span class="nv">$NODE</span>:/etc/kubernetes/kube-proxy.conf
     scp kube-proxy/kube-proxy.service <span class="nv">$NODE</span>:/usr/lib/systemd/system/kube-proxy.service
 <span class="k">done</span>

<span class="k">for</span> NODE in k8s-node01<span class="p">;</span> <span class="k">do</span>
     scp /etc/kubernetes/kube-proxy.kubeconfig <span class="nv">$NODE</span>:/etc/kubernetes/kube-proxy.kubeconfig
     scp kube-proxy/kube-proxy.conf <span class="nv">$NODE</span>:/etc/kubernetes/kube-proxy.conf
     scp kube-proxy/kube-proxy.service <span class="nv">$NODE</span>:/usr/lib/systemd/system/kube-proxy.service
 <span class="k">done</span>

systemctl daemon-reload
systemctl <span class="nb">enable</span> --now kube-proxy

<span class="c1">#安装Calico 3.11.1</span>
<span class="nb">cd</span> /root/k8s-ha-install/Calico/
kubectl create -f calico.yaml
kubectl get po -n kube-system -o wide
kubectl get node
kubectl cluster-info

<span class="nb">cd</span> /root/k8s-ha-install/CoreDNS/
kubectl create -f coredns.yaml
kubectl get po -n kube-system
kubectl logs -f coredns-76b74f549-7znbw -n kube-system

<span class="c1">#集群验证</span>
cat<span class="s">&lt;&lt;EOF | kubectl apply -f -
</span><span class="s">apiVersion: v1
</span><span class="s">kind: Pod
</span><span class="s">metadata:
</span><span class="s">  name: busybox
</span><span class="s">  namespace: default
</span><span class="s">spec:
</span><span class="s">  containers:
</span><span class="s">  - name: busybox
</span><span class="s">    image: busybox:1.28
</span><span class="s">    command:
</span><span class="s">      - sleep
</span><span class="s">      - &#34;3600&#34;
</span><span class="s">    imagePullPolicy: IfNotPresent
</span><span class="s">  restartPolicy: Always
</span><span class="s">EOF</span>

kubectl <span class="nb">exec</span>  busybox -n default -- nslookup kubernetes
kubectl <span class="nb">exec</span>  busybox -n default -- nslookup kube-dns.kube-system


journalctl -xefu kubelet
<span class="c1">#nftables https://hezhiqiang8909.gitbook.io/nftables/</span>
nft list ruleset

</code></pre></td></tr></table>
</div>
</div>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Myki</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2020-01-20
        
    </span>
  </p>
  
  
</div>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	
	<ins class="adsbygoogle"
		style="display:block"
		data-ad-client="ca-pub-2427629508597494"
		data-ad-slot="2287897972"
		data-ad-format="auto"
		data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>

    
    <footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kubernetes/">kubernetes</a>
          <a href="/tags/linux/">linux</a>
          <a href="/tags/centos/">centos</a>
          </div>
      <nav class="post-nav">
        
        <a class="next" href="/post/centos8_install/">
            <span class="next-text nav-default">centos8 安装体验install</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://www.1nth.com/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2018 - 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Myki</span>
    <br><a href="http://beian.miit.gov.cn">京ICP备17054644号</a><br />
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-154483127-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-154483127-1');
</script>






</body>
</html>
